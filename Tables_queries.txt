CREATE OR REPLACE DATABASE CHROMA DATA_RETENTION_TIME_IN_DAYS = 7;
CREATE OR REPLACE SCHEMA   CHROMA.STG;
CREATE OR REPLACE SCHEMA   CHROMA.INT;
CREATE OR REPLACE SCHEMA   CHROMA.PRS;
create or replace schema chroma.lab;

use schema chroma.lab

CREATE OR REPLACE TRANSIENT TABLE RAW_EVENTS_JSON (RAW VARIANT, LOADED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP());
INSERT INTO RAW_EVENTS_JSON(RAW)
SELECT PARSE_JSON('{"event":"purchase","orderId":"TXN-1001","items":[{"sku":"CR-MOB-00001","qty":1,"price":14999.00}],
"customer":{"id":123,"tier":"Gold"},"ts":"2025-09-01T10:30:00Z"}');

DESCRIBE TABLE CHROMA.LAB.RAW_EVENTS_JSON;	

select raw:orderId::string as ORDER_ID, raw:customer:id::Number as CUSTOMER_ID, to_timestamp_tz(raw:tz) as EVENT_TS 
from raw_events_json

select raw:orderId::string as ORDER_ID, i.value:sku::string as sku,i.value:qty::number as QTY, i.value:price::float as Price,raw:customer:id::Number as CUSTOMER_ID, raw:tier::string as Tier
from raw_events_json, lateral flatten(input => raw:items)i


USE ROLE SYSADMIN;

USE SCHEMA CHROMA.INT;

create or replace table sales_demo_perm(SALES_ID NUMBER, SALES_DATE DATE, QTY NUMBER(8,0), UNIT_PRICE NUMBER(10,2), NET NUMBER(12,2));
INSERT INTO SALES_DEMO_PERM VALUES (1,'2025-09-01',2,14999,29998);


select * from CHROMA.INT.SALES_DEMO_PERM;

describe table CHROMA.INT.SALES_DEMO_PERM

CREATE WAREHOUSE IF NOT EXISTS WH_TRANSFORM WAREHOUSE_SIZE = SMALL  AUTO_SUSPEND=60 AUTO_RESUME=TRUE;
CREATE WAREHOUSE IF NOT EXISTS WH_BI        WAREHOUSE_SIZE = SMALL  AUTO_SUSPEND=60 AUTO_RESUME=TRUE;
CREATE WAREHOUSE IF NOT EXISTS WH_INGEST    WAREHOUSE_SIZE = XSMALL AUTO_SUSPEND=60 AUTO_RESUME=TRUE;

USE WAREHOUSE WH_INGEST;
use schema chroma.stg;

CREATE OR REPLACE TRANSIENT TABLE STG_PRODUCT(
  PRODUCT_ID NUMBER NOT NULL, PRODUCT_SKU STRING NOT NULL, PRODUCT_NAME STRING,
  BRAND STRING, CATEGORY STRING, SUBCATEGORY STRING, COLOR STRING, SIZE STRING,
  UNIT_PRICE NUMBER(10,2), START_DATE DATE, END_DATE DATE, IS_ACTIVE BOOLEAN,
  _LOAD_TS TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),
  CONSTRAINT PK_STG_PRODUCT PRIMARY KEY (PRODUCT_ID) NOT ENFORCED
);
CREATE OR REPLACE TRANSIENT TABLE STG_EMPLOYEE(
  EMPLOYEE_ID NUMBER NOT NULL, FIRST_NAME STRING, LAST_NAME STRING, EMAIL STRING, PHONE STRING,
  HIRE_DATE DATE, TERMINATION_DATE DATE, STORE_ID NUMBER, JOB_TITLE STRING,
  _LOAD_TS TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);
CREATE OR REPLACE TRANSIENT TABLE STG_CUSTOMER(
  CUSTOMER_ID NUMBER NOT NULL, FIRST_NAME STRING, LAST_NAME STRING, EMAIL STRING, PHONE STRING,
  GENDER STRING, BIRTH_DATE DATE, ADDRESS STRING, CITY STRING, STATE STRING, POSTAL_CODE STRING,
  COUNTRY STRING, SIGNUP_DATE DATE, LOYALTY_TIER STRING,
  _LOAD_TS TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);
CREATE OR REPLACE TRANSIENT TABLE STG_STORE(
  STORE_ID NUMBER NOT NULL, STORE_NAME STRING, STORE_NUMBER NUMBER, FORMAT STRING,
  ADDRESS STRING, CITY STRING, STATE STRING, POSTAL_CODE STRING, COUNTRY STRING, REGION STRING,
  OPEN_DATE DATE, CLOSE_DATE DATE, SQ_FT NUMBER(10,0),
  _LOAD_TS TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);
CREATE OR REPLACE TRANSIENT TABLE STG_SALES(
  SALES_ID NUMBER NOT NULL, SALES_DATE DATE NOT NULL, SALES_TIME TIME,
  STORE_ID NUMBER, PRODUCT_ID NUMBER, CUSTOMER_ID NUMBER, EMPLOYEE_ID NUMBER,
  QUANTITY NUMBER(8,0), UNIT_PRICE NUMBER(10,2),
  GROSS_AMOUNT NUMBER(12,2), DISCOUNT_AMOUNT NUMBER(12,2) DEFAULT 0, NET_AMOUNT NUMBER(12,2),
  PAYMENT_TYPE STRING, TRANSACTION_ID STRING,
  _LOAD_TS TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);
CREATE OR REPLACE TRANSIENT TABLE STG_INVENTORY(
  INVENTORY_ID NUMBER NOT NULL, SNAPSHOT_DATE DATE NOT NULL,
  STORE_ID NUMBER, PRODUCT_ID NUMBER, ON_HAND_QTY NUMBER(12,0), ON_ORDER_QTY NUMBER(12,0) DEFAULT 0,
  REORDER_POINT NUMBER(8,0) DEFAULT 15, UNIT_COST NUMBER(10,2),
  _LOAD_TS TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);

USE WAREHOUSE WH_TRANSFORM;
USE SCHEMA CHROMA.INT;

drop table CHROMA.INT.STG_CUSTOMER;
drop table CHROMA.INT.STG_EMPLOYEE;
drop table CHROMA.INT.STG_INVENTORY;
drop table CHROMA.INT.STG_PRODUCT;
drop table CHROMA.INT.STG_SALES;
drop table CHROMA.INT.STG_STORE;

CREATE OR REPLACE TABLE DIM_PRODUCT(
  PRODUCT_KEY NUMBER IDENTITY START 1,
  PRODUCT_ID NUMBER NOT NULL, PRODUCT_SKU STRING NOT NULL, PRODUCT_NAME STRING,
  BRAND STRING, CATEGORY STRING, SUBCATEGORY STRING, COLOR STRING, SIZE STRING,
  UNIT_PRICE NUMBER(10,2), IS_ACTIVE BOOLEAN,
  CONSTRAINT UQ_DIM_PRODUCT UNIQUE (PRODUCT_ID) NOT ENFORCED
);
CREATE OR REPLACE TABLE DIM_EMPLOYEE(
  EMPLOYEE_KEY NUMBER IDENTITY START 1,
  EMPLOYEE_ID NUMBER NOT NULL, FIRST_NAME STRING, LAST_NAME STRING, EMAIL STRING, PHONE STRING,
  HIRE_DATE DATE, TERMINATION_DATE DATE, STORE_ID NUMBER, JOB_TITLE STRING,
  CONSTRAINT UQ_DIM_EMPLOYEE UNIQUE (EMPLOYEE_ID) NOT ENFORCED
);
CREATE OR REPLACE TABLE DIM_CUSTOMER(
  CUSTOMER_KEY NUMBER IDENTITY START 1,
  CUSTOMER_ID NUMBER NOT NULL, FIRST_NAME STRING, LAST_NAME STRING, EMAIL STRING, PHONE STRING,
  GENDER STRING, BIRTH_DATE DATE, CITY STRING, STATE STRING, POSTAL_CODE STRING, COUNTRY STRING, LOYALTY_TIER STRING,
  CONSTRAINT UQ_DIM_CUSTOMER UNIQUE (CUSTOMER_ID) NOT ENFORCED
);
CREATE OR REPLACE TABLE DIM_STORE(
  STORE_KEY NUMBER IDENTITY START 1,
  STORE_ID NUMBER NOT NULL, STORE_NAME STRING, STORE_NUMBER NUMBER, FORMAT STRING,
  CITY STRING, STATE STRING, POSTAL_CODE STRING, COUNTRY STRING, REGION STRING, SQ_FT NUMBER(10,0),
  CONSTRAINT UQ_DIM_STORE UNIQUE (STORE_ID) NOT ENFORCED
);
CREATE OR REPLACE TABLE FACT_SALES(
  SALES_KEY NUMBER IDENTITY START 1,
  SALES_ID NUMBER NOT NULL, SALES_DATE DATE NOT NULL,
  STORE_KEY NUMBER, PRODUCT_KEY NUMBER, CUSTOMER_KEY NUMBER, EMPLOYEE_KEY NUMBER,
  QUANTITY NUMBER(8,0), UNIT_PRICE NUMBER(10,2),
  GROSS_AMOUNT NUMBER(12,2), DISCOUNT_AMOUNT NUMBER(12,2) DEFAULT 0, NET_AMOUNT NUMBER(12,2),
  PAYMENT_TYPE STRING, TRANSACTION_ID STRING
);
CREATE OR REPLACE TABLE FACT_INVENTORY(
  INV_KEY NUMBER IDENTITY START 1,
  INVENTORY_ID NUMBER NOT NULL, SNAPSHOT_DATE DATE NOT NULL,
  STORE_KEY NUMBER, PRODUCT_KEY NUMBER,
  ON_HAND_QTY NUMBER(12,0), ON_ORDER_QTY NUMBER(12,0) DEFAULT 0, REORDER_POINT NUMBER(8,0) DEFAULT 15,
  UNIT_COST NUMBER(10,2)
);


