CREATE OR REPLACE STORAGE INTEGRATION AZURE_BLOB_INT
  TYPE = EXTERNAL_STAGE
  STORAGE_PROVIDER = AZURE
  ENABLED = TRUE
  AZURE_TENANT_ID = '16625689-dffc-4ee5-b9de-2d326a40554c'
  STORAGE_ALLOWED_LOCATIONS = ('azure://akhilsnowflake.blob.core.windows.net/demofile/demofiles/');

DESC INTEGRATION AZURE_BLOB_INT;

-- Generic JSON format (arrays ? rows; strip nulls for compact objects)
CREATE OR REPLACE FILE FORMAT FF_JSON
  TYPE = JSON
  STRIP_OUTER_ARRAY = TRUE
  STRIP_NULL_VALUES = TRUE
  IGNORE_UTF8_ERRORS = TRUE;

-- External stage (point at your container root)
CREATE OR REPLACE STAGE AZ_STAGE_JSON
  URL = 'azure://akhilsnowflake.blob.core.windows.net/demofile/demofiles/'
  STORAGE_INTEGRATION = AZURE_BLOB_INT
  FILE_FORMAT = (FORMAT_NAME = FF_JSON);

LIST @AZ_STAGE_JSON;

CREATE OR REPLACE NOTIFICATION INTEGRATION MY_NOTIFICATION_INT
  TYPE = QUEUE
  NOTIFICATION_PROVIDER = AZURE_STORAGE_QUEUE
  AZURE_STORAGE_QUEUE_PRIMARY_URI = 'https://akhilsnowflake.queue.core.windows.net/snowpipedemo'
  AZURE_TENANT_ID = '16625689-dffc-4ee5-b9de-2d326a40554c'
  ENABLED = TRUE;

DESC INTEGRATION MY_NOTIFICATION_INT; 

USE WAREHOUSE WH_INGEST;
USE SCHEMA CHROMA.STG;


CREATE OR REPLACE PIPE P_SALES_JSON
  AUTO_INGEST = TRUE
  INTEGRATION = 'MY_NOTIFICATION_INT'
AS
COPY INTO STG_SALES_JSON (RAW, FILE_NAME)
FROM (
  SELECT $1, METADATA$FILENAME
  FROM @AZ_STAGE_JSON
)
FILE_FORMAT = (FORMAT_NAME = FF_JSON);


CREATE OR REPLACE TABLE STG_SALES_JSON (
  RAW VARIANT,
  FILE_NAME STRING,
  LOAD_TS TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);

--ALTER PIPE P_SALES_JSON REFRESH;

select * from STG_SALES_JSON;

SELECT 
    RAW:orderId:: STRING AS ORDER_ID,
    RAW:region::STRING AS REGION,
    RAW:customer:tier::STRING AS CUSTOMER_TIER,
    ARRAY_SIZE(RAW:items) AS NUM_ITEMS,
    RAW:items as ITEMS_ARRAY
FROM STG_SALES_JSON;

select RAW:orderId, i.value from STG_SALES_JSON, LATERAL FLATTEN(INPUT => RAW:items) i;

SELECT
 RAW:orderId:: STRING AS ORDER_ID,
 i.value:productId::NUMBER AS PRODUCT_ID,
 i.value:qty::NUMBER AS QTY,
 i.value:price::NUMBER AS PRICE,
 (i.value:price::NUMBER * i.value:qty::NUMBER)::NUMBER(12,2) AS LINE_TOTAL
 from STG_SALES_JSON,
 LATERAL FLATTEN(INPUT => RAW:items) i;

with expanded as(
SELECT 
  RAW:orderId::STRING AS ORDER_ID,
  (i.value:qty::NUMBER * i.value:price::NUMBER)::NUMBER(12,2) AS LINE_TOTAL,
  RAW:discount::NUMBER AS DISCOUNT
  FROM STG_SALES_JSON,
  LATERAL FLATTEN(INPUT => RAW:items) i
)

SELECT ORDER_ID,
    SUM(LINE_TOTAL) AS GROSS_AMOUNT,
    ANY_VALUE(DISCOUNT) AS DISCOUNT,
    SUM(LINE_TOTAL) - ANY_VALUE(DISCOUNT) AS NET_WORTH
FROM expanded
GROUP BY ORDER_ID;





  

